@{
    Layout = "_DashboardLayout";
}
@using smart_home_web.Models.Dashboard;
@using smart_home_web.Components;
@model DashboardViewModel;

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gridstack@0.6.0/dist/gridstack.min.css" />
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gridstack@0.6.0/dist/gridstack.all.js"></script>

<h1>@Model.Name Dashboard</h1>

<div class="grid-stack" data-save-url="@Url.Action("UpdateOptions", "DashboardOptions")">
    @foreach (var report in Model.ReportElements)
    {<div id="@report.Id" class="grid-stack-item shadow-standart card" data-gs-x="@report.X" data-gs-y="@report.Y" data-gs-width="@report.Width" data-gs-height="@report.Height">
            <div class="grid-stack-item-content">
               <div >@await Component.InvokeAsync(report.Type.ToString(), new { reportElementId = report.Id })</div>
            </div>
        </div>
    }
</div>

<script type="text/javascript">

    let arrToJson = arr => {
        let obj = {}
        for (const i in arr) {
            obj[i] = arr[i]
        }
        return obj
    }

    $('.grid-stack').gridstack();
    $('body').on('change', '.grid-stack', function (event, items) {
        var options = [];
        options = items.map(i => {
            return { id: parseInt(i.el[0].id), x: i.x, y: i.y, width: i.width, height: i.height }
        });

        $.ajax({
            type: "POST",
            url: $(".grid-stack").data("save-url"),
            data: { options: arrToJson(options) }
        });
    });

    $('body').on('gsresizestop', '.grid-stack', function (event, ui) {
        ui.reflow();
    });
</script>