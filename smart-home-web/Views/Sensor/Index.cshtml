@using smart_home_web.Models.SensorViewModel;

@model IEnumerable<SensorViewModel>

@{
    ViewData["Title"] = "Sensors";
}
<link href="~/css/OnOff.css" rel="stylesheet" />
@*<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>*@

<h2>Sensors List</h2>
@if (User.Identity.IsAuthenticated)
{
    <div class="button-center">
        <a asp-action="Create" class="btn btn-success">Add new sensor</a>
    </div>
}
<table class="table text-center" data-save-url="@Url.Action("SetActive", "Sensor")">
    <thead>
        <tr>
            <th scope="col">On/Off</th>
            <th scope="col">Icon</th>
            <th scope="col">Sensor</th>
            <th scope="col">Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model)
        {
            @await Component.InvokeAsync("SensorElement", item)
        }
    </tbody>
</table>

@*class 'fade' don't working in Bootstrap 4*@
<div class="modal" id="modalWindow" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable" role="document">
        <div class="modal-content">

            <div class="modal-header">
                <h4 class="modal-title"></h4>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body"></div>
        </div>
    </div>
</div>

<div id="modal-delete-confirm" class="d-none">
    <a class="btn btn-primary" id="modal-delete-button" data-sensor-type-id="">Delete</a>
    <a class="btn btn-secondary" data-dismiss="modal">Cancel</a>
</div>


<script src="~/lib/jquery/dist/jquery.js"></script>
<script>
    $(function () {
        let currentRow = null;
        const modal = $("#modalWindow");
        const modalBody = modal.find(".modal-body");
        const tableBody = $("table").find("tbody");
        $(".sensor-type-edit").click(SensorTypeEdit);
        $(".sensor-type-create").click(SensorTypeCreate);
        $(".sensor-type-delete").click(SensorTypeDeleteConfirm);

        function SensorTypeEdit() {
            currentRow = $(this).closest(".sensor-type-row");
            modal.modal("hide");
            $.ajax({
                url: '@Url.Action("Edit","SensorType")',
                data: { id: currentRow.data("sensor-type-row-id") },
                beforeSend: function () {
                    modal.fadeIn(600);
                    return true;
                },
                success: function (data) {
                    modal.find(".modal-title").text("Edit Sensor Type");
                    modalBody.prepend(data);
                    modalBody.on("submit", "#modal-form-edit", ModalFormEditSubmit);
                    modalBody.on("click", ".back-to-list", HideModal);
                    modal.modal("show");
                },
                error: function (res) {
                    console.log(res);
                }
            });
        }

        function SensorTypeCreate() {
            $.ajax({
                url: '@Url.Action("Create","SensorType")',
                beforeSend: function () {
                    modal.fadeIn(600);
                    return true;
                },
                success: function (data) {
                    modal.find(".modal-title").text("Create Sensor Type");
                    modalBody.prepend(data);
                    modalBody.on("submit", "#modal-form-create", ModalFormCreateSubmit);
                    modalBody.on("click", ".back-to-list", HideModal);
                    modal.modal("show");
                },
                error: function (res) {
                    console.log(res);
                }
            });
        }

        function SensorTypeDeleteConfirm() {
            currentRow = $(this).closest(".sensor-type-row");
            modal.find(".modal-title").text("Are you sure ?");
            $("#modal-delete-confirm").clone().prependTo(modalBody);
            $("#modal-delete-confirm").show(0);
            $("#modal-delete-button").data("sensor-type-id", currentRow.data("sensor-type-row-id"));
            modalBody.on("click", "#modal-delete-button", SensorTypeDelete);
            modal.fadeIn(600);
            modal.modal("show");
        }

        function SensorTypeDelete() {
            $.ajax({
                url: '@Url.Action("Delete","SensorType")',
                data: { Id: $(this).data("sensor-type-id") },
                beforeSend: function () {
                    modal.modal("hide");
                    currentRow.hide(800, function () {
                        currentRow.remove();
                    });
                    return true;
                },
                error: function (res) {
                    console.log(res);
                }
            });
        }

        function ModalFormCreateSubmit() {
            event.preventDefault();
            var inputFile = $(this).find(".modal-form-file");
            var form = document.getElementById($(this).attr("id"));
            var fd = new FormData(form);
            fd.append('IconFile', inputFile.prop('files')[0]);
            $.ajax({
                url: '@Url.Action("Create","SensorType")',
                method: "POST",
                processData: false,
                contentType: false,
                data: fd,
                beforeSend: function () {
                    modal.modal("hide");
                    return true;
                },
                success: function (data) {
                    tableBody.prepend(data);
                    tableBody.on("click", ".sensor-type-edit", SensorTypeEdit);
                    tableBody.on("click", ".sensor-type-delete", SensorTypeDeleteConfirm);
                },
                error: function (res) {
                    console.log(res);
                }
            });
        }

        function ModalFormEditSubmit() {
            event.preventDefault();
            var inputFile = $(this).find(".modal-form-file");
            var form = document.getElementById($(this).attr("id"));
            var fd = new FormData(form);
            fd.append('IconFile', inputFile.prop('files')[0]);

            $.ajax({
                url: '@Url.Action("Edit","SensorType")',
                method: "POST",
                processData: false,
                contentType: false,
                data: fd,
                beforeSend: function () {
                    modal.modal("hide");;
                    currentRow.hide(800);
                    return true;
                },
                success: function (data) {
                    currentRow.replaceWith(data);
                    currentRow.show(800);
                    tableBody.on("click", ".sensor-type-edit", SensorTypeEdit);
                    tableBody.on("click", ".sensor-type-delete", SensorTypeDeleteConfirm);
                },
                error: function (res) {
                    console.log(res);
                }
            });
        }

        function HideModal() {
            modal.modal("hide");
        }

        modal.on('hidden.bs.modal', function () {
            modalBody.empty();
            $(this).find(".modal-title").empty();
        });
    });
</script>
<script>
    function toggleAdditionalInfo(e) {
        var subRow = e.nextElementSibling;
        subRow.style.display = subRow.style.display === 'none' ? 'inherit' : 'none';
    }

    $('.fa-eye-slash').click(function () {
        $(this).toggleClass('fa fa-eye');
        $(this).toggleClass('fa fa-eye-slash');
    });

    $('input').click(function () {
        $.ajax({
            type: 'Post',
            url: $('table').data('save-url'),
            data: { id: $(this).attr('id') },
            beforeSend: function () {
                $(".sensor-activated").toggleClass("fa-check-circle fa-times-circle");
            },
            success: function () {
                console.log('changed');
            }
        });
    });

    $(".sensor-delete").click(function () {
        if (confirm("Are you sure?")) {
            let parent = $(this).closest(".sensor-row");
            $.ajax({
                url:  '@Url.Action("Delete","Sensor")',
                data: { sensorId: $(this).data("sensorid") },
                beforeSend: function () {
                    parent.hide(800, function () {
                        parent.remove();
                    })
                    return true;
                }
            });
        }
    });


</script>